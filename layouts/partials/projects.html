{{ $contextType := printf "%T" . }}
{{ $isShortcode := (eq $contextType "*hugolib.ShortcodeWithPage") }}

<section id="projects" class="container section-experience section section--border-bottom rad-animation-group flex-grow-1">
  <div class="row flex-column-reverse flex-md-row rad-fade-down">
    <div class="experience-list col-12 col-md-6">
      <h2>
        {{ if $isShortcode }}
          {{ .Get "title" | default "" }}
        {{ else }}
          {{ i18n "projects_title" }}
        {{ end }}
      </h2>

      {{ $projects := where .Site.RegularPages.ByDate "Type" "projects" }}
      {{ if not $isShortcode }}
        {{ $baseLangSite := .Sites.Default }}
        {{ $projects = $projects | lang.Merge (where $baseLangSite.RegularPages.ByDate.Reverse "Type" "projects") }}
      {{ end }}

      {{ $projectsCount := len $projects }}
      {{ $totalCount := .Site.Params.homepageProjectsCount | default 6 }}

      {{ if not $isShortcode }}
      {{ if not .IsHome }}
        {{ $totalCount = $projectsCount }}
      {{ end }}
      {{ end }}

      <!-- Determine if we are on the homepage or project page -->
      {{ $displayProjects := $projects }}
      
      <!-- On homepage (called via shortcode), only display the specified three projects -->
      {{ if $isShortcode }}
        {{ $targetTitles := slice "LLM-based Political Stance Classification" "Streamlit Soccer Platform" "Cafeteria Coffee App" }}
        {{ $displayProjects = slice }}
        {{ range $projects }}
          {{ if in $targetTitles .Title }}
            {{ $displayProjects = $displayProjects | append . }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ range first $totalCount $displayProjects }}
      <div class="experience">
        <a href="{{ .Permalink | relURL }}" class="experience__link">
          <div class="experience__header">
            {{ $img := resources.Get .Params.projectImage }}
            {{ with $img }}
              {{ $imgWebp := $img.Resize (printf "%dx%d webp q75 Lanczos picture" $img.Width $img.Height) }}
              <img 
                src="{{ $imgWebp.RelPermalink }}" 
                alt="{{ .Params.title }} preview"
                class="experience__company-logo"
                loading="lazy"
              />
            {{ end }}
            <div class="experience__meta">
              <!-- Completely remove date display -->
              <div class="experience__title">{{ .Title }}</div>
              <div class="experience__company">{{ .Params.technologies }}</div>
            </div>
          </div>
        </a>
      </div>
      {{ end }}

      {{ if and $isShortcode (gt $projectsCount 3) }}
      <div class="all-experience-container">
        {{ $projectsExtra := sub $projectsCount 3 }}
        <em>And {{ $projectsExtra }} more</em><br />
        <a href="{{ absURL "projects" | relLangURL }}" class="btn btn-primary btn-all-experience">
          <i class="icon-folder"></i>
          View All Projects
        </a>
      </div>
      {{ end }}
    </div>
    <div class="experience-description col-12 col-md-6">
      {{ partial "projects-description.html" . }}
    </div>
  </div>
</section>